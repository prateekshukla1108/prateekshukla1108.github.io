<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Prateek's Blog</title>
  <link rel="stylesheet" href="/blog/post.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>
  <div class="container">
  <div class="bg-layers" aria-hidden="true">
    <div class="grid"></div>
    <div class="scan"></div>
    <div class="cursor" id="cursorGlow"></div>
    <div class="data-stream"></div>
    <div class="data-stream"></div>
  </div>
    <header>
      <div class="header-content">
        <a href="/" class="home-icon">
          <i class="fas fa-home"></i>
        </a>
        <div class="theme-toggle">
          <i class="fas fa-moon"></i>
          <div class="toggle-slider">
            <div class="slider-icon"></div>
          </div>
          <i class="fas fa-sun"></i>
        </div>
      </div>
      <div class="labels" id="labels">
        <span class="label active" data-tag="all">All</span>
        <span class="label" data-tag="AI">AI</span>
        <span class="label" data-tag="Philosophy">Philosophy</span>
        <span class="label" data-tag="Life">Life</span>
        <span class="label" data-tag="Others">Others</span>
        <span class="label" data-tag="Neuroscience">Neuroscience</span>
      </div>
    </header>

    <section class="hero">
      <h1 class="glitch" data-text="Prateek's Blog">Prateek's Blog</h1>
      <p class="subtitle">AI • Philosophy • Life • Neuroscience</p>
      <p class="intro">Welcome to my brain where ideas spark, clash, and sometimes make sense.</p>
      <div class="cta-group">
        <a href="#posts" class="btn primary"><i class="fas fa-bolt"></i> Read Latest</a>
        <a href="#labels" class="btn ghost"><i class="fas fa-layer-group"></i> Explore Tags</a>
      </div>
      <div class="search-bar">
        <i class="fas fa-magnifying-glass"></i>
        <input id="searchInput" type="text" placeholder="Search posts by title, tag, or summary" aria-label="Search posts">
      </div>
    </section>

    <main id="posts">
      <div class="posts">
        <div class="loading">Loading posts...</div>
      </div>
    </main>

    <footer>
      <div class="social-links">
        
      </div>
    </footer>
  </div>

  <button class="back-to-top" id="backToTop" aria-label="Back to top" title="Back to top">
    <i class="fas fa-arrow-up"></i>
  </button>

  <script>
// Global state
let allPosts = [];
let currentTag = 'all';
let lastModified = null; // To store the last modified time
let searchQuery = '';
let reduceMotion = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;

// Theme Toggle
const body = document.body;

const themeToggle = document.querySelector('.toggle-slider');
themeToggle.addEventListener('click', () => {
  body.classList.toggle('light-mode');
  localStorage.setItem('theme', body.classList.contains('light-mode') ? 'light' : 'dark');
});

// Load saved theme
if (localStorage.getItem('theme') === 'light') {
  body.classList.add('light-mode');
}

// Note: Removed dynamic markdown rendering to reduce JS size and work; static HTML posts are linked

// URL state helpers
function getStateFromURL() {
  const params = new URLSearchParams(location.search);
  return {
    tag: params.get('tag') || 'all',
    q: params.get('q') || ''
  };
}

function updateURLState(tag, q) {
  const params = new URLSearchParams(location.search);
  if (tag && tag !== 'all') params.set('tag', tag); else params.delete('tag');
  if (q && q.trim()) params.set('q', q.trim()); else params.delete('q');
  const newUrl = params.toString() ? `${location.pathname}?${params.toString()}` : location.pathname;
  history.replaceState(null, '', newUrl);
}

// Debounce utility
function debounce(fn, delay = 150) {
  let t;
  return (...args) => {
    clearTimeout(t);
    t = setTimeout(() => fn.apply(null, args), delay);
  };
}

// Filter posts by tag
function filterPosts(tag) {
  currentTag = tag;
  applyFilters();

  // Update active label
  document.querySelectorAll('.label').forEach(label => {
    label.classList.toggle('active', label.dataset.tag === tag);
  });
  updateURLState(currentTag, searchQuery);
  localStorage.setItem('currentTag', currentTag);
}

function applyFilters() {
  const filteredByTag = currentTag === 'all' ? allPosts : allPosts.filter(post => post.tags.includes(currentTag));
  const q = searchQuery.trim().toLowerCase();
  const filtered = q
    ? filteredByTag.filter(post =>
        post.title.toLowerCase().includes(q) ||
        post.excerpt.toLowerCase().includes(q) ||
        (post.tags || []).join(' ').toLowerCase().includes(q)
      )
    : filteredByTag;
  displayPosts(filtered);
}

function rebuildLabelsFromPosts(posts) {
  const container = document.getElementById('labels');
  if (!container) return;
  const tagSet = new Set();
  posts.forEach(p => (p.tags || []).forEach(t => tagSet.add(t)));
  const tags = ['all', ...Array.from(tagSet).sort((a,b)=>a.localeCompare(b))];
  container.innerHTML = tags.map(t => `<span class="label ${t === currentTag ? 'active' : ''}" data-tag="${t}">${t}</span>`).join('');
}

// Display posts function
function displayPosts(posts) {
  const postsContainer = document.querySelector('.posts');

  if (posts.length === 0) {
    postsContainer.innerHTML = '<div class="error">No posts found</div>';
    return;
  }

  postsContainer.innerHTML = posts.map(post => `
    <article class="post" data-slug="${post.slug}">
        <div class="post-header">
            ${post.coverImage ? `<img src="${post.coverImage}" alt="${post.title}" class="post-cover" loading="lazy" decoding="async" referrerpolicy="no-referrer">` : ''}
            <h2 class="post-title">${post.title}</h2>
            <div class="post-meta">
                <span class="post-date"><i class="far fa-calendar"></i> ${new Date(post.date).toLocaleDateString()}</span>
                <span class="post-author"><i class="far fa-user"></i> ${post.author}</span>
                <span class="post-reading-time"><i class="far fa-clock"></i> ${post.readingTime}</span>
            </div>
        </div>

        <div class="post-tags">
            ${(post.tags || []).map(tag => `<span class="tag" onclick="event.preventDefault(); event.stopPropagation(); filterPosts('${tag}')">${tag}</span>`).join('')}
        </div>

        <p class="post-excerpt">${post.excerpt}</p>

        <a class="read-more" href="/blog/posts/${post.slug}.html">Read More</a>
    </article>`).join('');

  enableCardInteractions();
}

function enableCardInteractions() {
  if (reduceMotion) return;
  const cards = document.querySelectorAll('.post');
  cards.forEach(card => {
    const slug = card.getAttribute('data-slug');
    let rafId = 0;
    let lastX = 0, lastY = 0, rect = null;
    const onMove = (e) => {
      lastX = e.clientX; lastY = e.clientY;
      if (!rafId) {
        rafId = requestAnimationFrame(() => {
          rect = rect || card.getBoundingClientRect();
          const x = lastX - rect.left;
          const y = lastY - rect.top;
          const centerX = rect.width / 2;
          const centerY = rect.height / 2;
          const rotateY = ((x - centerX) / centerX) * 6;
          const rotateX = -((y - centerY) / centerY) * 6;
          card.style.transform = `perspective(800px) rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
          rafId = 0;
        });
      }
    };
    card.addEventListener('mousemove', onMove);
    card.addEventListener('mouseleave', () => {
      rect = null;
      card.style.transform = 'perspective(800px) rotateX(0deg) rotateY(0deg)';
    });
    card.addEventListener('click', (e) => {
      if (e.target.closest('.tag') || e.target.closest('.read-more')) return;
      if (slug) window.location.href = `/blog/posts/${slug}.html`;
    });
  });
}

// Load blog posts
async function loadBlogPosts() {
  try {
    let headers = {};

    // If lastModified exists, send it in the If-Modified-Since header
    if (lastModified) {
      headers = { 'If-Modified-Since': lastModified };
    }

    // Show skeletons while loading
    renderSkeletons();

    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 8000);
    const response = await fetch('/blog/posts.json', { headers, cache: 'no-cache', signal: controller.signal }).catch((e) => { throw e; });
    clearTimeout(timeout);

    if (response.status === 304) {
      // Not modified, do nothing
      return;
    } else if (response.ok) {
      const data = await response.json();
      allPosts = data.posts;

      // Get the new Last-Modified header
      lastModified = response.headers.get('Last-Modified');

      // Cache locally for offline
      try { localStorage.setItem('postsCache', JSON.stringify({ ts: Date.now(), posts: allPosts })); } catch (_) {}

      // Sort posts by date (newest first)
      allPosts.sort((a, b) => new Date(b.date) - new Date(a.date));

      // Restore state from URL/localStorage
      const state = getStateFromURL();
      const storedTag = localStorage.getItem('currentTag');
      currentTag = state.tag || storedTag || 'all';
      const input = document.getElementById('searchInput');
      searchQuery = state.q || '';
      if (input) input.value = searchQuery;

      // Build dynamic tags
      rebuildLabelsFromPosts(allPosts);

      // Display posts
      applyFilters();
    } else {
      throw new Error('Failed to load blog posts');
    }
  } catch (error) {
    console.error('Error loading blog posts:', error);
    // Try cache
    try {
      const cached = JSON.parse(localStorage.getItem('postsCache'));
      if (cached && Array.isArray(cached.posts)) {
        allPosts = cached.posts;
        allPosts.sort((a, b) => new Date(b.date) - new Date(a.date));
        rebuildLabelsFromPosts(allPosts);
        applyFilters();
        return;
      }
    } catch (_) {}
    document.querySelector('.posts').innerHTML = `
      <div class="error">
          <p>Error loading posts. Please try again later.</p>
          <p>Error details: ${error.message}</p>
      </div>`;
  }
}

function renderSkeletons(count = 6) {
  const postsContainer = document.querySelector('.posts');
  if (!postsContainer) return;
  postsContainer.innerHTML = Array.from({ length: count }).map(() => `
    <article class="post skeleton">
      <div class="image"></div>
      <div class="line" style="width: 60%"></div>
      <div class="line" style="width: 40%"></div>
      <div class="line" style="width: 90%"></div>
    </article>
  `).join('');
}

// Load posts when the page loads
document.addEventListener('DOMContentLoaded', () => {
  renderSkeletons();
  loadBlogPosts();
  const input = document.getElementById('searchInput');
  const cursorGlow = document.getElementById('cursorGlow');
  if (input) {
    const onInput = debounce((e) => {
      searchQuery = e.target.value || '';
      updateURLState(currentTag, searchQuery);
      applyFilters();
    }, 200);
    input.addEventListener('input', onInput);
  }
  // Label clicks via delegation
  const labelsContainer = document.getElementById('labels');
  if (labelsContainer) {
    labelsContainer.addEventListener('click', (e) => {
      const el = e.target.closest('.label');
      if (!el) return;
      filterPosts(el.dataset.tag);
    });
  }
  // Keyboard shortcut to focus search
  window.addEventListener('keydown', (e) => {
    if (e.key === '/' && !(e.target instanceof HTMLInputElement)) {
      e.preventDefault();
      input && input.focus();
    }
  });
  // Back to top button
  const backBtn = document.getElementById('backToTop');
  const onScroll = () => {
    if (!backBtn) return;
    if (window.scrollY > 400) backBtn.classList.add('visible'); else backBtn.classList.remove('visible');
  };
  window.addEventListener('scroll', onScroll, { passive: true });
  backBtn && backBtn.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));

  // Cursor-follow glow (throttled)
  let lastX = 0, lastY = 0, rafPending = false;
  window.addEventListener('mousemove', (e) => {
    if (!cursorGlow) return;
    lastX = e.clientX; lastY = e.clientY;
    if (!rafPending) {
      rafPending = true;
      requestAnimationFrame(() => {
        cursorGlow.style.setProperty('--mx', lastX + 'px');
        cursorGlow.style.setProperty('--my', lastY + 'px');
        rafPending = false;
      });
    }
  }, { passive: true });
});

// Set interval to check for updates every 5 minutes
setInterval(loadBlogPosts, 300000);

// (Replaced by delegated listener on #labels)

</script>

</body>

</html>
